<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TUTæ´—æ¾¡åŠ©æ‰‹-Vantç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=0 user-scalable=no">
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="./css/vant.css"/>
    <link rel="stylesheet" href="./css/index.css"/>
    <!-- å¼•å…¥ Vue å’Œ Vant çš„ JS æ–‡ä»¶ -->
    <script src="./js/vue.min.js"></script>

    <script src="./js/vant.min.js"></script>
    <script src="./js/orderUtil.js"></script>
    <script src="./js/axios.min.js"></script>
    <script src="./js/md5.min.js"></script>
</head>
<body>

<div id="app">

    <div v-if="tab==='list'" style="margin-top: 2rem">
        <h2 style="text-align: center;">ğŸ¤¸â€â™‚æˆ‘çš„é¢„çº¦</h2>
        <div style="text-align: center;opacity: 0.6;">å¾€å·¦æ»‘é¢„çº¦å±•å¼€æ“ä½œé¢æ¿</div>
        <div style="height: 1rem"></div>
        <div style="text-align: left;margin: 0">
            <van-swipe-cell v-for="order in orders" style="margin-bottom: 1rem">
                <van-cell center :title="order.period" @click="orderClick(order)" is-link>
                    <template #title>
                        <div style="display: flex;flex-direction:column;justify-items: left;align-items: flex-start">
                            <span style="font-size: 1.2rem">{{ order.period }}</span>
                            <div>
                                <span style="opacity: 0.8;margin-right: 0.3rem">{{ order.bathRoomName }}</span>
                                <van-tag plain v-if="order.status==0" type="success">å·²é¢„çº¦</van-tag>
                                <van-tag plain v-if="order.status==0 && Date.now() - 300000>=order.periodEndTime"
                                         type="warning">è¯·å‰å¾€
                                </van-tag>
                                <van-tag plain v-if="order.status==0 && Date.now() - 100000>=order.periodEndTime"
                                         type="danger">å³å°†è¶…æ—¶
                                </van-tag>
                                <van-tag plain v-if="order.status==1" type="primary">å·²æ‰«ç </van-tag>
                                <van-tag plain v-if="order.status==2" type="success">å·²å®Œæˆ</van-tag>
                                <van-tag plain v-if="order.status==3" type="danger">å·²è¶…æ—¶</van-tag>
                                <van-tag plain v-if="order.status==4" type="">å·²å½’æ¡£</van-tag>
                            </div>

                        </div>
                    </template>

                </van-cell>
                <template #right>
                    <van-button style="height: 100%" type="danger" text="å–æ¶ˆé¢„çº¦"
                                @click="cancelBook(order.id,order.period)"></van-button>
                </template>
            </van-swipe-cell>

            <van-empty v-if="orders.length==0" description="ä½ è¿˜æ²¡æœ‰é¢„çº¦"></van-empty>

        </div>

    </div>

    <div v-if="tab==='order'" style="text-align: center;margin-top: 2rem">
        <h2>ğŸ˜‹æ–°çš„é¢„çº¦</h2>
        <van-tabs v-model:active="newOrder.room" style="text-align: left;" sticky @click-tab="onClickTab">
            <van-tab v-for="room in newOrder.rooms" :title="room.name" :name="room.id"
            >
                <van-list
                        :finished="true"
                        finished-text="æ²¡æœ‰æ›´å¤šäº†">
                    <van-cell v-for="book in newOrder.list" :key="book"
                              :value="book.remain+'/'+book.maxBookNum" is-
                              @click="orderConfirm(book.id,book.period)">
                        <template #title>
                            <span style="margin-right: 0.8rem">{{ book.period }}</span>
                            <van-tag v-if="book.remain>=1" type="success" size="small" plain>å¯é¢„çº¦</van-tag>
                        </template>
                    </van-cell>
                </van-list>
            </van-tab>
        </van-tabs>
    </div>

    <div v-if="tab==='me'" style="text-align: center;margin: 2rem">
        <h2>ğŸ‘¦æˆ‘çš„ä¿¡æ¯</h2>
        <van-cell-group style="text-align: left" inset>
            <van-cell title="è´¦æˆ·ä¿¡æ¯" is-link value="ä¿®æ”¹" @click="meinfo.show=true"></van-cell>
            <van-cell v-if="" title="è´¦æˆ·ç­‰çº§" center
                      :value="'Lv.'+(localData.exp/50 +1) +' '+(localData.exp % 50 ?? '0') +'/'+'50' "></van-cell>
            <van-cell v-if="api!==undefined" title="è´¦æˆ·ä¼šå‘˜" center>
                <template #label>
                    <div style="margin-top: 0.2rem">

                        <van-tag plain style="margin-right: 0.2rem" color="#FC7903">è‡³å°Šæ´—æ¾¡å¹´å¡</van-tag>
                        <van-tag plain style="margin-right: 0.2rem" color="#003153">927VIP</van-tag>
                        <van-tag v-if="meinfo.user==='20191951'" style="margin-right: 0.5rem" plain color="#20B2AA">
                            é’é¾™åƒæœˆSVIP
                        </van-tag>
                        <van-tag v-if="meinfo.user==='20191953'" style="margin-right: 0.5rem" plain color="#00BCD4">
                            çˆ±ç©¿ç™½è¢œçš„é€šè®¯å½•
                        </van-tag>
                        <van-tag v-if="meinfo.user==='20191955'" style="margin-right: 0.5rem" plain color="#F01C20">
                            æ‘†çƒ‚ä¹‹äºº
                        </van-tag>
                        <van-tag style="margin-right: 0.5rem" plain color="#F01C20">
                            å•¥ä¹Ÿä¸çŸ¥é“
                        </van-tag>
                    </div>

                </template>
            </van-cell>
        </van-cell-group>
        <van-image
                @click="qrcodeClick"
                width="280"
                height="280"
                :src="meinfo.qrcode">
            <template v-slot:loading>
                <van-loading type="spinner" size="20"></van-loading>
            </template>
        </van-image>
    </div>

    <van-tabbar v-model="tab" fixed="true" @change="(active)=>{tab = active}">
        <van-tabbar-item icon="fire-o" name="list">æˆ‘çš„é¢„çº¦</van-tabbar-item>
        <!--        <van-tabbar-item icon="search">å†å²</van-tabbar-item>-->
        <van-tabbar-item icon="aim" name="order">å¼€å§‹é¢„å®š</van-tabbar-item>
        <van-tabbar-item icon="smile-o" name="me">æˆ‘çš„ä¿¡æ¯</van-tabbar-item>
    </van-tabbar>

    <!-- è´¦æˆ·ä¿¡æ¯è¾“å…¥é¡µé¢  -->
    <van-dialog v-model:show="meinfo.show" title="ä¿¡æ¯ä¿®æ”¹" show-cancel-button @confirm="confirmUserInfo">
        <van-cell-group inset>
            <van-field v-model="meinfo.user" label="è´¦æˆ·" placeholder="è¾“å…¥è´¦æˆ·å..(å­¦å·)"></van-field>
            <van-field v-model="meinfo.pwd" label="å¯†ç " placeholder="è¾“å…¥å¯†ç "></van-field>
        </van-cell-group>
    </van-dialog>
</div>

<script>
    const {createApp} = Vue
    const {Toast, Dialog, ImagePreview} = vant


    let app = createApp({
        data() {
            return {
                tab: 'me',
                meinfo: {
                    show: false,
                    user: '',
                    pwd: '',
                    qrcode: ''
                },
                api: undefined,
                orders: [],
                newOrder: {
                    rooms: [],
                    room: '',
                    list: [],
                    active: ''
                },
                localData: {
                    exp: 0,
                    addExp(exp) {
                        localStorage.setItem('exp', this.getExp() + exp)
                        this.exp = this.getExp()
                    },
                    getExp() {
                        this.exp = localStorage.getItem('exp') ?? 0
                        return this.exp
                    }
                }
            }
        },
        mounted() {
            let user = localStorage.getItem('user.user') ?? ''
            let pwd = localStorage.getItem('user.pwd') ?? ''
            if (pwd === "" || user === "") {
                Dialog.alert({message: "ç”¨æˆ·ä¿¡æ¯ä¸ºç©º,è¯·ç¡®å®šè´¦æˆ·ä¿¡æ¯ã€‚"})
                this.meinfo.show = true;
            } else {
                this.meinfo.user = user;
                this.meinfo.pwd = pwd;
                OrderUtil.login(this.meinfo.user, this.meinfo.pwd).then(api => {
                    if (api) {
                        this.api = api;
                        this.refreshData();
                        this.checkin();
                    } else {
                        Toast('è´¦æˆ·é”™è¯¯');
                    }
                })
            }
        },
        methods: {
            checkin() {
                if (localStorage.getItem('checkin-' + new Date().toLocaleDateString()) === 'true') {
                    this.localData.getExp();
                } else {
                    localStorage.setItem('checkin-' + new Date().toLocaleDateString(), true.toString())
                    this.localData.addExp(50)
                    Toast('ä»Šæ—¥ç­¾åˆ°æˆåŠŸ,ç»éªŒ+50')
                }

            },
            async confirmUserInfo() {
                let api = await OrderUtil.login(this.meinfo.user, this.meinfo.pwd)
                if (api) {
                    localStorage.setItem('user.user', this.meinfo.user);
                    localStorage.setItem('user.pwd', this.meinfo.pwd);
                    Toast('è´¦æˆ·ä¿¡æ¯ç¡®è®¤æˆåŠŸ');
                    this.api = api;
                    await this.refreshData();
                } else {
                    Toast('ç”¨æˆ·ä¿¡æ¯é”™è¯¯...ç™»å…¥å¤±è´¥');
                }
            },
            async refreshData() {
                let qr_code = await this.api.getQRCode()
                if (qr_code) {
                    this.meinfo.qrcode = qr_code
                    console.log(this.meinfo.qrcode)
                }
                let list = await this.api.getOrderList()
                this.orders = list

                this.newOrder.rooms = await this.api.getRoomList()
                this.newOrder.list = await this.api.getBookList(this.newOrder.rooms[0].id)

                this.checkin();

            },
            async onClickTab(data) {
                let {name} = data;
                this.newOrder.list = await this.api.getBookList(name);

            },
            cancelBook(id, period) {
                Dialog.confirm({
                    title: 'å–æ¶ˆé¢„çº¦',
                    message: `ä½ ç¡®å®šå–æ¶ˆé¢„çº¦ã€Œ${period}ã€?`
                }).then(async x => {
                    let data = await this.api.cancel(id);
                    if (data) {
                        Toast('å–æ¶ˆæˆåŠŸ!')
                        this.refreshData()
                    }
                }).catch(x => {
                    Toast('å–æ¶ˆå¤±è´¥!')
                })
            }
            ,
            orderConfirm(bookId, period) {
                Dialog.confirm({
                    title: 'æ–°çš„é¢„çº¦',
                    message: `ä½ ç¡®å®šé¢„çº¦æ—¶é—´æ®µğŸ˜…ã€Œ${period}ã€`
                }).then(async x => {
                    let data = await this.api.order(bookId);
                    if (data) {
                        localData.addExp(10);
                        Toast('é¢„çº¦æˆåŠŸï¼Œè·å¾—10ç»éªŒå€¼ã€‚')
                        this.refreshData()
                    }
                }).catch(x => {

                })
            },
            vipClick() {
                Toast('ä½ æ˜¯å°Šè´µçš„VIPã€‚ä½†æ˜¯æ²¡ä»€ä¹ˆå‡ æŠŠç”¨ã€‚')
            },
            orderClick(order) {
                Dialog.alert({
                    title: 'é¢„çº¦è¯¦æƒ…',
                    message: 'é¢„çº¦æ—¶é—´æ®µ:' + order.period + '\n' + 'é¢„çº¦åœ°ç‚¹:' + order.bathRoomName
                })
            },
            qrcodeClick() {
                ImagePreview({
                    images: [this.meinfo.qrcode],
                    closeable: true,
                });
            }
        }
    })

    app.use(vant)
    app.use(vant.Tabbar, vant.TabbarItem)
    app.use(vant.Dialog)
    app.use(vant.Image)
    app.use(vant.Empty)
    app.use(vant.Tab, vant.Tabs)
    app.use(vant.Cell, vant.CellGroup, vant.SwipeCell)
    app.mount('#app')
</script>
</body>
</html>